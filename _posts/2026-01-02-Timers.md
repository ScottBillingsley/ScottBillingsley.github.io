## Timers

When I started writing my emulator, I was using the TCA0 timer for
timing and SPI for the video out. SPI is fine for a text screen, one
of my video cards even does 2 bit color, ie 3 shades of cyan and off, 
but is too slow for video games. I did some testing and found I could
send 4 bytes of data on a parallel bus during the horizontal sync pulse.

![]({{site.baseurl}}/images/chip8/Video Timing.png)

I have both the H sync and V sync coming from the video card. The AVR128DB48
doesn't have a hardware interrupt but does have pin interrupts. Here is 
some example code of how to setup pin interrupts on the AVR128DB48.

```c++
namespace ISR_PORTB {
isr_callback_t isr_callback_function = NULL;

void attach_interrupt(isr_callback_t callback) {
  isr_callback_function = callback;
}

 ISR(PORTB_PORT_vect) {
 
  uint8_t flags = PORTB.INTFLAGS;
  
   if (isr_callback_function != NULL) {
     isr_callback_function();
   }
  
  PORTB.INTFLAGS = flags;
 }
} 
```
You then need to set a pin on that port as INPUT and set it's interrupt
trigger.

```c++
  /* Set PORTB pin 0 as INPUT for H sync Interrupt */
  PORTB.DIRCLR = PIN0_bm;
  /* Non invert, Schmitt trigger, BOTH */
  PORTB.PIN0CTRL =  PORT_ISC_0_bm;
```
Then attach a function to handle the interrupt.

```c++
  /* Attach a function to handle the interrupt */
  ISR_PORTB::attach_interrupt(pin_interrupt);
```