## Timers

When I started writing my emulator, I was using the TCA0 timer for
timing and SPI for the video out. SPI is fine for a text screen, one
of my video cards even does 2 bit color, ie 3 shades of cyan and off, 
but is too slow for video games. I did some testing and found I could
send 4 bytes of data on a parallel bus during the horizontal sync pulse.

![]({{site.baseurl}}/images/chip8/Video Timing.png)

I have both the H sync and V sync coming from the video card. The AVR128DB48
doesn't have a hardware interrupt but does have pin interrupts. Here is 
some example code of how to setup pin interrupts on the AVR128DB48.

```c++

namespace ISR_PORTB {

isr_callback_t isr_callback_function = NULL;

/* Attach a function to the interrupt */
void attach_interrupt(isr_callback_t callback) {
  isr_callback_function = callback;
}

ISR(PORTB_PORT_vect) {
  /* Read the flags */
  uint8_t flags = PORTB.INTFLAGS;
  /* Call the interrupt handler */
  if (isr_callback_function != NULL) {
    isr_callback_function();
  }
  /* Clear the flags */
  PORTB.INTFLAGS = flags;
}

} /* End ISR_PORTB */
```

You then need to set a pin on that port as INPUT and set it's interrupt
trigger.

```c++
  /* Set PORTB pin 0 as INPUT for H sync Interrupt */
  PORTB.DIRCLR = PIN0_bm;
  /* Non invert, Schmitt trigger, BOTH */
  PORTB.PIN0CTRL =  PORT_ISC_0_bm;
```
Then attach a function to handle the interrupt.

```c++
  /* Attach a function to handle the interrupt */
  ISR_PORTB::attach_interrupt(pin_interrupt);
```
If you look at the timing diagram, you can see this interrupt will fire
at 31.7 uS or aprox 31.5 kHz. So we can also use this interrupt to 
provide the main timer for the emulator.
By setting a 16 bit variable as a counter.

```cpp
    /*
        Increment the system clock at
        31.5 kHz off the H_sync
    */
    sys.clock ++;
```
We can use a simple AND to get a clock for the sound and delay timers.

```cpp
    if ((sys.clock & 0x01FF) == 0x00)
    {
      sys.delay_clock = !sys.delay_clock;
      previous_state = !sys.delay_clock;
    }
```
31545 divided by 512 is aprox 60 times a second..

```cpp
    /*
         Delay timer and sound timer
    */
    if (sys.delay_clock == true && previous_state == false)
    {
      if (chip8.dt > 0x00)
      {
        chip8.dt --;
      }

      if (chip8.st > 0x00)
      {
        chip8.st --;
        sys.sound_on = true;
      } else {
        sys.sound_on = false;

      }
      previous_state = true;
    }

  }
```
My first idea for sound was just a simple piezo beeper. While this did work
it was loud and annoying after a while. So I decided to use the h sync timer 
to also make a more pleasant tone by switching a pin on and off. 

```cpp
    /*
        Tone clock
    */
    if ((((sys.clock >> 5) & 0x01) == 0x01) && sys.sound_on == true)
    {
      PORTF.OUTSET = PIN5_bm;
    } else {
      PORTF.OUTCLR = PIN5_bm;
    }
```
31545 divided by 32 is 985 divided by 2 is a nice 492 Hz tone.

```cpp
    if ((sys.clock & sys.speed) == 0x00)
    {

      sys.cpu_clock = !sys.cpu_clock;

    }
```

The cpu clock has 3 divisions of the system clock. 
Fast speed is 0x1F or divide by 32 for 980 Hz rate,
Normal is 0x3F or divide by 64 for 490 Hz,
and Slow is 0x7F or divide by 128 for 246 Hz.


 
